#!/bin/sh

NAME1=bsa_server
DAEMON1=/usr/bin/$NAME1
PIDFILE1=/var/run/$NAME1.pid

NAME2=app_musicBox
DAEMON2=/usr/bin/$NAME2
PIDFILE2=/var/run/$NAME2.pid


HW_PLATFORM=$(cat /proc/device-tree/amlogic-dt-id | awk -F "_" '{print $2}')
if [ "${HW_PLATFORM}" == "s400" ];then
    hcd_file="/etc/wifi/6255/BCM4345C0.hcd"
elif [ "${HW_PLATFORM}" == "s420" ];then
    hcd_file="/etc/wifi/4356/bcm4356a2.hcd"
else
    echo "$0: not s400/s420, exit!"
    exit 1
fi
#echo "hcd_file = $hcd_file"

function set_btname()
{
    name_file=/etc/wifi/ap_name
    if [ -f $ap_name_file ];then
        bt_name=`cat /etc/wifi/ap_name`
    fi
    echo "bt_name=MusicBox-$bt_name" > /etc/bsa/config/bt_configure.txt

}

Blue_start()
{
    echo 0 > /sys/class/rfkill/rfkill0/state
    sleep 1
    echo 1 > /sys/class/rfkill/rfkill0/state
    sleep 1

    set_btname

    cd /etc/bsa/config
    echo "start broadcom bluetooth server bsa_sever"
    start-stop-daemon -S  -m -p $PIDFILE1 -x $DAEMON1 -- -r 13 -lpm -all=0 -b /etc/bsa/config/btsnoop.log -p $hcd_file -d /dev/ttyS1 &
    sleep 2

    echo "start broadcom bluetooth app_musicBox"
    start-stop-daemon -S  -m -p $PIDFILE2 -x $DAEMON2 &

    sleep 1

    echo
    echo "|-----bluetooth speaker is ready for connections------|"

    cd - > /dev/null

}

Blue_stop()
{
    echo -n "Stopping broadcom bluetooth server & app"
    start-stop-daemon -K -o -p $PIDFILE2
    sleep 1
    start-stop-daemon -K -o -p $PIDFILE1
    sleep 2
    rm -f $PIDFILE1
    rm -f $PIDFILE2
    echo 0 > /sys/class/rfkill/rfkill0/state
    echo
    echo "|-----bluetooth music player is shutdown-----|"
}

skt_handle()
{
		skt_board=`cat /proc/device-tree/amlogic-dt-id`
		case ${skt_board} in
			"axg_a113d_skt_v1")
				exit 0
				;;
			"axg_a113x_skt_v1")
				exit 0
				;;
		esac
	Blue_start &
}

case "$1" in
    start)
	skt_handle &

        ;;
    netready|netup|netdown|netchange) ;;
    stop)
        Blue_stop
        ;;
    *)
        echo "Usage: $0 {start|stop}"
        exit 1
esac

exit $?

